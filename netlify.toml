# netlify.toml (v3 - Root Configuration)

[build]
  base = "." # Repository root
  command = "npm run build" # Skip tests for production deployment
  publish = "packages/frontend/dist/"
  functions = "packages/backend/netlify/functions/" # Updated functions directory
  environment = { NPM_FLAGS = "--legacy-peer-deps" }
  SECRETS_SCAN_ENABLED = false
  SECRETS_SCAN_OMIT_PATHS = [
    "README.md",
    "all_markdown_and_code_snapshot_llm_distilled.txt",
    "packages/frontend/dist/assets/*.js"
  ]


[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200

# ===================================================================
# THE DEFINITIVE FIX: Function Bundler Configuration
# ===================================================================
# This tells Netlify's bundler how to handle our backend functions.
# Note the correct TOML syntax: [functions."function-name"]
[functions]

  # Configuration for the main API function
  [functions."api-mjs"]
    # Tell the bundler to NOT bundle these specific packages.
    # Instead, Netlify will include them in the function's node_modules
    # so they can be required/imported at runtime, just like in local dev.
    external_node_modules = [
      "express",
      "cors",
      "serverless-http",
      "dotenv",
      "supabase",
      "@supabase/supabase-js"
    ]

  # Configuration for the SMS function
  [functions."send-sms-mjs"]
    external_node_modules = ["twilio"]

# Removed [secrets] section and all secrets scanning related settings
