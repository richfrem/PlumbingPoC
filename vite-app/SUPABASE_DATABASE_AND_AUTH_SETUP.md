# Table of Contents

1.  [Supabase Database Configuration](#1-supabase-database-configuration)
    -   [Table Schema Overview](#1a-table-schema-overview)
    -   [Storage Bucket: PlumbingPoCBucket](#1b-storage-bucket-plumbingpocbucket)
    -   [Row Level Security (RLS) Policies](#1c-row-level-security-rls-policies)
2.  [Master SQL Setup Script](#2-master-sql-setup-script)
3.  [Authentication Provider Configuration](#3-authentication-provider-configuration)
4.  [Helpful CLI Commands & Queries](#4-helpful-cli-commands--queries)

---

# Supabase & Authentication Provider Setup Reference

This document provides a comprehensive reference for the project's Supabase database schema, security policies, and authentication provider setup.

## 1. Supabase Database Configuration

### 1a. Table Schema Overview

The database is composed of several related tables to manage users, requests, quotes, and communications.

-   **user_profiles**
    -   Stores public-facing user data, linked one-to-one with `auth.users`.
    -   `id` (uuid, primary key)
    -   `user_id` (uuid, **unique**, references `auth.users.id`)
    -   `role` (text, e.g., 'admin', 'customer')
    -   `name`, `email`, `phone`, `address`, `city`, `province`, `postal_code` (text)
    -   `created_at` (timestamptz)

-   **requests**
    -   The core table for initial customer quote requests.
    -   `id` (uuid, primary key)
    -   `user_id` (uuid, references `user_profiles.user_id`)
    -   `customer_name`, `service_address`, `contact_info`, `problem_category`, etc. (text)
    -   `is_emergency` (boolean)
    -   `answers` (jsonb)
    -   `status` (text, e.g., 'new', 'viewed', 'quoted')
    -   `created_at` (timestamptz)

-   **quote_attachments**
    -   Stores records of files uploaded for a specific request.
    -   `id` (uuid, primary key)
    -   `request_id` (uuid, references `requests.id`)
    -   `file_name` (text)
    -   `mime_type` (text)
    -   `file_url` (text, public URL from storage)
    -   `created_at` (timestamptz)

-   **quotes**
    -   Stores formal quotes generated by an admin for a request.
    -   `id` (uuid, primary key)
    -   `request_id` (uuid, references `requests.id`)
    -   `user_id` (uuid, references `auth.users.id`)
    -   `quote_amount` (numeric)
    -   `details` (text)
    -   `status` (text, e.g., 'draft', 'sent', 'accepted')
    -   `created_at` (timestamptz)

-   **request_notes**
    -   A log of all communication between the customer and admin regarding a request.
    -   `id` (uuid, primary key)
    -   `request_id` (uuid, references `requests.id`)
    -   `user_id` (uuid, references `auth.users.id`)
    -   `author_role` (text, 'admin' or 'customer')
    -   `note` (text)
    -   `created_at` (timestamptz)

-   **invoices**
    -   Stores invoice data linked to an accepted quote.
    -   `id` (uuid, primary key)
    -   `quote_id` (uuid, references `quotes.id`)
    -   `user_id` (uuid)
    -   `amount_due` (numeric), `due_date` (timestamptz), `status` (text)

### 1b. Storage Bucket: PlumbingPoCBucket

-   **Purpose:** Securely stores all user-uploaded files (images, PDFs) related to quote requests.
-   **Access:** This bucket is **NOT** public. All access is controlled by Storage Policies.
-   **Policies (SQL):**
    ```sql
    -- Allows any logged-in user to UPLOAD a file.
    CREATE POLICY "Allow authenticated uploads"
    ON storage.objects FOR INSERT
    TO authenticated
    WITH CHECK ( bucket_id = 'PlumbingPoCBucket' );

    -- Allows an ADMIN to view/download ANY file for the dashboard.
    CREATE POLICY "Allow admin read access"
    ON storage.objects FOR SELECT
    TO authenticated
    USING ( (SELECT role FROM public.user_profiles WHERE user_id = auth.uid()) = 'admin' );
    ```

### 1c. Row Level Security (RLS) Policies

RLS is **ENABLED** on all public tables to ensure users can only access their own data.

-   **user_profiles:**
    -   Users can view, update, and insert their own profile only.
-   **requests:**
    -   Admins have full access.
    -   Users can perform all actions on their own requests only.
-   **quote_attachments:**
    -   Admins and the request owner can view attachments.
    -   Only the request owner can insert new attachments.
-   **quotes:**
    -   Admins have full access.
    -   Users can only view quotes linked to their `user_id`.
-   **request_notes:**
    -   Admins have full access.
    -   Users can view and create notes on their own requests.
-   **invoices:**
    -   Admins have full access.
    -   Users can only view invoices linked to their `user_id`.

## 2. Master SQL Setup Script

This single, idempotent script can be run in the Supabase SQL Editor to create all tables, establish relationships, and apply all security policies from a fresh project.

```sql
-- ========= Create Tables (if they don't exist) =========
CREATE TABLE IF NOT EXISTS public.quotes (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  request_id uuid NOT NULL REFERENCES public.requests(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  quote_amount numeric(10, 2), details text, status text DEFAULT 'draft' NOT NULL, created_at timestamptz DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.request_notes (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  request_id uuid NOT NULL REFERENCES public.requests(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  author_role text NOT NULL, note text NOT NULL, created_at timestamptz DEFAULT now()
);

-- ========= Add Constraints (if they don't exist) =========
ALTER TABLE public.user_profiles ADD CONSTRAINT user_profiles_user_id_key UNIQUE (user_id);
ALTER TABLE public.requests ADD CONSTRAINT requests_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(user_id);

-- ========= Enable RLS on All Tables =========
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quote_attachments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.quotes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.request_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.invoices ENABLE ROW LEVEL SECURITY;

-- ========= RLS Policies for user_profiles =========
DROP POLICY IF EXISTS "Users can view their own profile" ON public.user_profiles;
CREATE POLICY "Users can view their own profile" ON public.user_profiles FOR SELECT TO authenticated USING ( auth.uid() = user_id );

DROP POLICY IF EXISTS "Users can update their own profile" ON public.user_profiles;
CREATE POLICY "Users can update their own profile" ON public.user_profiles FOR UPDATE TO authenticated USING ( auth.uid() = user_id ) WITH CHECK ( auth.uid() = user_id );

-- ========= RLS Policies for quote_attachments =========
DROP POLICY IF EXISTS "Allow authenticated insert for attachments" ON public.quote_attachments;
CREATE POLICY "Allow authenticated insert for attachments" ON public.quote_attachments FOR INSERT TO authenticated WITH CHECK ( auth.uid() = (SELECT user_id FROM requests WHERE id = request_id) );

DROP POLICY IF EXISTS "Admins and owners can view attachments" ON public.quote_attachments;
CREATE POLICY "Admins and owners can view attachments" ON public.quote_attachments FOR SELECT TO authenticated USING ( ((SELECT role FROM public.user_profiles WHERE user_id = auth.uid()) = 'admin') OR (auth.uid() = (SELECT user_id FROM requests WHERE id = request_id)) );

-- ========= RLS Policies for quotes =========
DROP POLICY IF EXISTS "Admins have full access to quotes" ON public.quotes;
CREATE POLICY "Admins have full access to quotes" ON public.quotes FOR ALL TO authenticated USING ( (SELECT role FROM public.user_profiles WHERE user_id = auth.uid()) = 'admin' );

DROP POLICY IF EXISTS "Users can view their own quotes" ON public.quotes;
CREATE POLICY "Users can view their own quotes" ON public.quotes FOR SELECT TO authenticated USING ( auth.uid() = user_id );

-- ========= RLS Policies for request_notes =========
DROP POLICY IF EXISTS "Admins have full access to request notes" ON public.request_notes;
CREATE POLICY "Admins have full access to request notes" ON public.request_notes FOR ALL TO authenticated USING ( (SELECT role FROM public.user_profiles WHERE user_id = auth.uid()) = 'admin' );

DROP POLICY IF EXISTS "Users can view notes on their own requests" ON public.request_notes;
CREATE POLICY "Users can view notes on their own requests" ON public.request_notes FOR SELECT TO authenticated USING ( auth.uid() = (SELECT user_id FROM requests WHERE id = request_id) );

DROP POLICY IF EXISTS "Users can create notes on their own requests" ON public.request_notes;
CREATE POLICY "Users can create notes on their own requests" ON public.request_notes FOR INSERT TO authenticated WITH CHECK ( auth.uid() = (SELECT user_id FROM requests WHERE id = request_id) );

-- ========= RLS Policies for invoices =========
DROP POLICY IF EXISTS "Admins have full access to invoices" ON public.invoices;
CREATE POLICY "Admins have full access to invoices" ON public.invoices FOR ALL TO authenticated USING ( (SELECT role FROM public.user_profiles WHERE user_id = auth.uid()) = 'admin' ) WITH CHECK ( (SELECT role FROM public.user_profiles WHERE user_id = auth.uid()) = 'admin' );

DROP POLICY IF EXISTS "Users can view their own invoices" ON public.invoices;
CREATE POLICY "Users can view their own invoices" ON public.invoices FOR SELECT TO authenticated USING ( auth.uid() = user_id );

## 3. Authentication Provider Configuration

### 3a. Updating URLs
- Set Site URL for local development: `http://localhost:3000` or `http://localhost:5173/`
- Add Redirect URLs:
  - `http://localhost:3000/*`
  - `http://localhost:5173/`
- Save changes in Supabase dashboard under Authentication → URL Configuration.

### 3b. Adding Authentication Providers
- Go to Supabase dashboard → Authentication → Providers
- Enable and configure each provider (Google, Azure)

### 3c. Configuring Applications for OAuth

#### Google OAuth2 Client Setup (Google Cloud Console)
1. Go to Google Cloud Console → APIs & Services → Credentials → Create OAuth 2.0 Client ID.
2. Choose "Web application" as the application type.
3. Set the name (e.g., PlumbingPoCClient).
4. Add Authorized redirect URI:
   - `https://<your-supabase-project>.supabase.co/auth/v1/callback`
5. (Optional) Add Authorized JavaScript origins for local development:
   - `http://localhost:3000`
   - `http://localhost:5173`
6. Save and copy the Client ID and Client Secret.
7. Enter these values in Supabase dashboard under Authentication → Providers → Google.
8. Ensure the following scopes are enabled in Google:
   - `email`
   - `profile`
   - `openid`
9. Save changes in both Supabase and Google Cloud Console.

URL:  https://console.cloud.google.com/auth/clients/287129746720-a0thtekpior3iqdq67a31go02r6p945p.apps.googleusercontent.com?project=plumbingpoc


#### Azure Entra App Registration (Microsoft Entra Admin Center)
1. Register a new app in Microsoft Entra admin center.
2. Set the Redirect URI:
   - Platform: Web
   - URI: `https://<your-supabase-project>.supabase.co/auth/v1/callback`
3. Certificates & Secrets:
   - Create a new client secret and copy the value.
4. API Permissions:
    - Microsoft Graph → Delegated permissions:
       - `openid` (required for authentication)
       - `email` (required to get user's email)
       - `User.Read` (required to read user profile info)
    - Click "Grant admin consent" for your directory to ensure all permissions are active.
5. Token Configuration (Optional Claims):
    - Go to "Token configuration" in Azure portal.
    - Add an optional claim for `email` in the ID token:
       - Click "Add optional claim" → ID token → select `email`.
       - Confirm the claim appears in the list as shown in the Azure portal.
       - This ensures the user's email is included in the token sent to Supabase.
    - (Status: claim added as of August 21, 2025)
6. Branding & Properties:
   - Set app name and logo as desired.
7. Enter Azure Client ID and Client Secret in Supabase dashboard under Authentication → Providers → Azure.
8. Save changes in both Supabase and Azure portal.

URL:  https://entra.microsoft.com/?culture=en-us&country=us#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/Overview/appId/d9c00059-056f-4ab3-93c6-ea7009c00f23/isMSAApp~/false

## 4. Troubleshooting
- Ensure all permissions are granted and consented.
- Make sure the client secret is valid and matches Supabase.
- Confirm the redirect URI is identical in both provider and Supabase.
- For Google, ensure `email` scope is enabled.
- For Microsoft, ensure `openid`, `email`, and `profile` scopes are enabled.

---

## 5. Supabase information

### supabase cli
-- npx supabase login
-- npx supabase link

### install supabase on macos
brew install supabase/tap/supabase
supabase --version

### supabase database dump
export PGPASSWORD='YOUR_PASSWORD'
pg_dump 'postgresql://PlumbingPoC@oxoiwzijacglgueemlva.supabase.co:5432/postgres' --schema-only --file="supabase_schema_audit.sql"

### Query 1: Table & Column Schema
SELECT 
    c.table_schema,
    c.table_name,
    c.column_name,
    c.data_type,
    c.is_nullable,
    c.column_default
FROM 
    information_schema.columns c
WHERE 
    c.table_schema = 'public'
ORDER BY 
    c.table_name, 
    c.ordinal_position;

### Query 2: Row Level Security (RLS) Policies
SELECT
    p.schemaname AS schema_name,
    p.tablename AS table_name,
    p.policyname AS policy_name,
    p.permissive,
    p.cmd AS command_type,
    p.qual AS policy_expression,
    p.with_check AS with_check_expression
FROM
    pg_policies p
WHERE
    p.schemaname = 'public'
ORDER BY
    p.tablename,
    p.policyname;

### Query 3: Storage Buckets & Policies

SELECT 
    id,
    name,
    public,
    avif_autodetection,
    file_size_limit,
    allowed_mime_types
FROM 
    storage.buckets;


_Last updated: August 21, 2025_
